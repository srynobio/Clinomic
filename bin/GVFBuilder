#!/usr/bin/perl
use strict;
use warnings;
use lib '/home/srynearson/GVF-Clin/lib';
use GVF::Build;
use Getopt::Long;

our ($VERSION) = '1';

my $usage = "\n
DESCRIPTION:
USAGE:
OPTIONS(required):
\n";


my ( $gvf, $help, $valadate, $per, $tabix, $noVal );
 
my $result = GetOptions(
    'gvf=s'     => \$gvf,
    'percent=s' => \$per,
    'tbx=s'     => \$tabix,
    'noVal'     => \$noVal,
    'help'      => \$help,
) || die $usage;

# print message
if ( $help ){ die $usage }

if ( $gvf ) {


    my $file;
    if ( $per ){
        # Make new object for gvf file.
        $file = GVF::Build->new(
            gvf_file      => $gvf,
        );
        $file->set_ref_match($per);
    }
    else {
        # Make new object for gvf file.
        $file = GVF::Build->new(
            gvf_file   => $gvf,
        );
    }

 if ( ! $noVal )
 {
    # valadate the file for gene information and reference match
    my ($valid, $hasGene, $match) = $file->gvf_valadate;

    # if fasta match is not met, the file will not be added, and the program will die.
    if (  ! $$valid  ) {
        die "\n Your GVF file does not match the reference at ", $file->get_ref_match,
            "% it will not be added to the database\n\n Match percent: ", int($$match), "%\n\n";
    }
    elsif ( $$valid && $$hasGene ){
        print "
               File matches at ", $file->get_ref_match, "% and contains gene annotations.
               File will be added to database.
        \n\n";
        # add file to db
        $file->populate_gvf_data;
    }
    else {
        #if ( $tabix ){
            print "\nLooking for gene matches using NCBI current feature build file\nMatch percent: ", int($$match), "%\n\n";
            #$file->tabix_build($tabix);
            $file->tabix_build;
        #}
        #else {
         #   print "\nFile has no gene information via Varient_effect, please include tabix file\n\n$usage";
        #}
    }
 }
 elsif ( $noVal) {
    $file->populate_gvf_data;
 }
}

else {
    print "
        Unable to add GVF file to database, please check files and include all required options.
        \n$usage\n";
}



